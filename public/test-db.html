<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .result {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .error {
            background: #ffe8e8;
            border: 1px solid #f44336;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        pre {
            background: #fff;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üóÑÔ∏è Database Integration Test</h1>
    <p>This page tests the browser-to-backend database API integration.</p>

    <div class="test-section">
        <h3>1. Database Status</h3>
        <button onclick="testStatus()">Check Status</button>
        <div id="status-result"></div>
    </div>

    <div class="test-section">
        <h3>2. Session Management</h3>
        <button onclick="createSession()">Create Session</button>
        <button onclick="listSessions()">List Sessions</button>
        <button onclick="endSession()">End Current Session</button>
        <div id="session-result"></div>
    </div>

    <div class="test-section">
        <h3>3. Entity Simulation</h3>
        <button onclick="simulateEntity()">Simulate Entity Birth/Death</button>
        <div id="entity-result"></div>
    </div>

    <div class="test-section">
        <h3>4. Analytics</h3>
        <button onclick="getAnalytics()">Get Session Analytics</button>
        <div id="analytics-result"></div>
    </div>

    <script type="module">
        import { DatabaseAPI } from '/src/utils/DatabaseAPI.js';
        
        // Create global instance
        window.dbAPI = new DatabaseAPI();
        window.currentSessionId = null;

        // Test functions
        window.testStatus = async function() {
            try {
                const status = await window.dbAPI.checkStatus();
                document.getElementById('status-result').innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Database Status</h4>
                        <pre>${JSON.stringify(status, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                document.getElementById('status-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        window.createSession = async function() {
            try {
                const sessionId = await window.dbAPI.startSession(
                    'Browser Test Session',
                    'Testing database integration from browser',
                    { populationSize: 5, gridSize: 100 }
                );
                
                window.currentSessionId = sessionId;
                
                document.getElementById('session-result').innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Session Created</h4>
                        <p>Session ID: ${sessionId}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('session-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        window.listSessions = async function() {
            try {
                const sessions = await window.dbAPI.getSessions();
                
                document.getElementById('session-result').innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Sessions Retrieved</h4>
                        <pre>${JSON.stringify(sessions, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                document.getElementById('session-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        window.endSession = async function() {
            if (!window.currentSessionId) {
                document.getElementById('session-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>No active session to end</p>
                    </div>
                `;
                return;
            }

            try {
                await window.dbAPI.endSession(100, 10, 85.5);
                
                document.getElementById('session-result').innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Session Ended</h4>
                        <p>Session ${window.currentSessionId} ended successfully</p>
                    </div>
                `;
                
                window.currentSessionId = null;
            } catch (error) {
                document.getElementById('session-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        window.simulateEntity = async function() {
            if (!window.currentSessionId) {
                document.getElementById('entity-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>Please create a session first</p>
                    </div>
                `;
                return;
            }

            try {
                // Simulate entity birth
                const mockEntity = {
                    id: 'test-entity-' + Date.now(),
                    x: 50,
                    y: 50,
                    energy: 100,
                    age: 0,
                    fitness: 0,
                    totalEnergyGained: 0
                };

                await window.dbAPI.recordEntityBirth(mockEntity, 1, 1, null);
                
                // Simulate some metrics
                window.dbAPI.recordEntityMetrics(mockEntity, 1, 'move', 1.0);
                window.dbAPI.recordEntityMetrics(mockEntity, 2, 'stay', 0.5);
                
                // Simulate death after some ticks
                mockEntity.age = 50;
                mockEntity.fitness = 75.0;
                mockEntity.totalEnergyGained = 150;
                
                await window.dbAPI.recordEntityDeath(mockEntity, 50, 'energy_depletion');
                
                document.getElementById('entity-result').innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Entity Simulation Complete</h4>
                        <p>Entity ${mockEntity.id} born, lived 50 ticks, and died</p>
                        <p>Recorded birth, 2 metric points, and death</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('entity-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        window.getAnalytics = async function() {
            if (!window.currentSessionId) {
                document.getElementById('analytics-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>Please create a session first</p>
                    </div>
                `;
                return;
            }

            try {
                const [trends, topEntities] = await Promise.all([
                    window.dbAPI.getPopulationTrends(),
                    window.dbAPI.getTopEntities(5)
                ]);

                document.getElementById('analytics-result').innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Analytics Retrieved</h4>
                        <h5>Population Trends (${trends.length} data points):</h5>
                        <pre>${JSON.stringify(trends.slice(0, 3), null, 2)}</pre>
                        <h5>Top Entities (${topEntities.length}):</h5>
                        <pre>${JSON.stringify(topEntities, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                document.getElementById('analytics-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        // Auto-test status on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(window.testStatus, 500);
        });
    </script>
</body>
</html>